# CF-RNN 

本代码为论文《Driving Behavior Prediction Considering Cognitive Prior and Driving Context》的CF-LSTM模型代码

## 1.设计说明

在原有F-RNN-EL的基础上加入延时模块；

delayTime.py文件中包含了以下函数：

```python
generate_train_for_new_features
generate_test_for_new_features
generate_delay_train_time
generate_delay_test_time
```

用于延时训练特征和测试特征，以及生成训练特征和测试特征


## 2.环境配置

使用python版本为python2

```pip install theano==0.9```

安装基于theano的NeuralModels：

```git clone https://github.com/asheshjain399/NeuralModels.git```

注意需要切换到icraversion分支下：

```cd NeuralModels```

```git checkout icraversion```

然后```python setup.py develop```即可完成环境配置

## 3.训练脚本

```python saveModels.py```即可进行训练与测试结果的保存

saveModels.py中包含可以设置的参数为：

重复训练的次数，默认为10

需要训练的行为预测类型actions有四种：

lane，turn，all， all_new_feature

前面三种为二维特征，all_new_feature为三维特征(也是一般用来比较的所有驾驶行为的特征)

执行过程为首先根据interval_time参数范围确定需要延时的多少，延时时间为:

$$delay\_time = interval\_time * 0.04 secs$$

根据delay_time执行

```python delayTime.py maneuver_type interval_time```

即可生成margin方法延时后的车内外特征；

然后执行

```python trainModels.py maneuver_type interval_time```

就可开始训练，默认训练600个epoch

最后执行

```python runbatchprediction.py maneuver_type _zhouxq interval_time```

测试结果会被保存到当前目录下的dong_models中，文件名的最后三位数字是延时帧数+第n次训练模型

## 4.预测脚本

runbatchprediction.py挑选出合适的阈值参数并且计算出预测结果保存为.pik文件；

plotResult.py可以通过参数设置得到某一反应延时下的各个评价指标的平均值；
传入2个参数，参数1为要进行测试的文件路径，需要修改最后的任务类型actions，参数2为要进行重复测试取均值的次数，9表示0-9共10次模型的均值

python plotResults.py  ./dong_models/complete_results_final_model_all_new_features 9

## 5.附brain4cars原始代码文档

### How to train your model?

You maneuver-rnn.py to train you model.

```
python maneuver-rnn.py index fold
```

`index` is the id of the dataset and `fold` is the fold number. Before running this script make sure that `path_to_dataset` and `path_to_checkpoints` are correctly defined. You can additionally choose the kind of architecture to train by setting the parameter `model_type`. For the time being some of these parameters are hardcoded in the script.

###How to test your model?

Testing a single checkpoint In order to evaluate at a single checkpoint see the script `evaluateCheckpoints.py`. Usually I don't run this script directly. Instead I call it from `runbatchprediction.py` or `generateBestResults.py`

Generating predictions for all checkpoints and thresholds Use `runbatchprediction.py`. This script helps choosing a correct checkpoint and threshold value for each fold. It outputs a pickle file with results for each tuple (fold_id,threshold,checkpoint)

Choosing the correct parameters for each fold For each fold one needs to choose the checkpoint and prediction threshold values. After `runbatchprediction.py` has finished. One can run `analyzeResults.py` with the pickle generated by `runbatchprediction.py` as input parameter.

Generating best numbers for the table Use `generateBestResults.py`.

```
python generateBestResults.py maneuver_type model_id
```

This script generates best results for a given model. It reads the configuration file in chekpoints/`maneuver_type`/`model_id`
